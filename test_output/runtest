#!/bin/bash
set -e

# Setup paths
BUILD_DIR="../build"
TEST_DIR="."
MK_EARTH="$BUILD_DIR/milk-streamtelemetry-mkearthseq"
FITS2PNG="$BUILD_DIR/milk-streamtelemetry-3DFITS-to-png"
PCA="$BUILD_DIR/milk-streamtelemetry-pca"

echo "=== Running Test Suite ==="

# 1. Generate Datasets
echo "Generating earthA..."
$MK_EARTH 200 "$TEST_DIR/earthA[0,0]" -speed 1.0 -size 100 100

echo "Generating earthB..."
$MK_EARTH 200 "$TEST_DIR/earthB[30,45]" -speed 1.0 -size 100 100

# 2. Visualize Frames
echo "Visualizing Frames..."
$FITS2PNG "$TEST_DIR/earthA.fits" "$TEST_DIR/earthA_frames.png" -n 5 -geom 5x1
$FITS2PNG "$TEST_DIR/earthB.fits" "$TEST_DIR/earthB_frames.png" -n 5 -geom 5x1

# 3. Run PCA
echo "Running PCA on earthA..."
$PCA 10 "$TEST_DIR/earthA.fits" "$TEST_DIR/modesA.fits" "$TEST_DIR/coeffsA.fits" > "$TEST_DIR/pcaA.log"

echo "Running PCA on earthB..."
$PCA 10 "$TEST_DIR/earthB.fits" "$TEST_DIR/modesB.fits" "$TEST_DIR/coeffsB.fits" > "$TEST_DIR/pcaB.log"

# 4. Visualize Modes
# Modes are stored as a 3D cube where Z is the mode index.
echo "Visualizing Modes..."
$FITS2PNG "$TEST_DIR/modesA.fits" "$TEST_DIR/modesA.png" -slices 0,1,2,3,4 -geom 5x1
$FITS2PNG "$TEST_DIR/modesB.fits" "$TEST_DIR/modesB.png" -slices 0,1,2,3,4 -geom 5x1

# 5. Reconstruct from PCA
echo "Reconstructing earthA..."
"$BUILD_DIR/milk-streamtelemetry-recon" "$TEST_DIR/modesA.fits" "$TEST_DIR/coeffsA.fits" "$TEST_DIR/reconA.fits"

echo "Reconstructing earthB..."
"$BUILD_DIR/milk-streamtelemetry-recon" "$TEST_DIR/modesB.fits" "$TEST_DIR/coeffsB.fits" "$TEST_DIR/reconB.fits"

echo "Visualizing Reconstruction..."
$FITS2PNG "$TEST_DIR/reconA.fits" "$TEST_DIR/reconA_frames.png" -n 5 -geom 5x1
$FITS2PNG "$TEST_DIR/reconB.fits" "$TEST_DIR/reconB_frames.png" -n 5 -geom 5x1

# 6. Run CCA
echo "Running CCA between earthA and earthB..."
# Using -npca 10 to reduce dimensionality before CCA
"$BUILD_DIR/milk-streamtelemetry-cca" -npca 10 5 "$TEST_DIR/earthA.fits" "$TEST_DIR/earthB.fits"

# CCA outputs ccaA.fits and ccaB.fits (canonical vectors) in the current directory (or where run from?)
# The code writes to "ccaA.fits" and "ccaB.fits".
# If we run from TEST_DIR, they will be there.
# Let's ensure they are moved or we run in TEST_DIR.
# Since we are running with $TEST_DIR paths, the C code opens those files.
# But it writes to "ccaA.fits" (hardcoded). So it writes to CWD.
# We are running this script. The CWD is where we invoke it from.
# The previous steps used $TEST_DIR for outputs.
# Let's assume we run this script from its directory or handle the moves.
# The step "$BUILD_DIR/milk-streamtelemetry-cca" will write to CWD.

# Only move if the source and destination are different
if [ ! "ccaA.fits" -ef "$TEST_DIR/ccaA.fits" ]; then
    mv ccaA.fits "$TEST_DIR/ccaA.fits"
fi
if [ ! "ccaB.fits" -ef "$TEST_DIR/ccaB.fits" ]; then
    mv ccaB.fits "$TEST_DIR/ccaB.fits"
fi

echo "Visualizing CCA Vectors..."
$FITS2PNG "$TEST_DIR/ccaA.fits" "$TEST_DIR/ccaA_vectors.png" -slices 0,1,2,3,4 -geom 5x1
$FITS2PNG "$TEST_DIR/ccaB.fits" "$TEST_DIR/ccaB_vectors.png" -slices 0,1,2,3,4 -geom 5x1

# 7. Generate Report
echo "Generating Report..."
cat <<EOF > "$TEST_DIR/report.md"
# Milk Stream Telemetry Test Report

This report documents the testing of the Earth sequence generation and analysis tools.

## 1. Earth Datasets Generation

Two simulated datasets were generated representing a rotating Earth from different viewpoints.

**Commands:**
\`\`\`bash
# Generate Earth A (View: Lat 0, Lon 0)
$MK_EARTH 200 "earthA[0,0]" -speed 1.0 -size 100 100

# Generate Earth B (View: Lat 30, Lon 45)
$MK_EARTH 200 "earthB[30,45]" -speed 1.0 -size 100 100
\`\`\`

### Earth A
![Earth A Frames](earthA_frames.png)

### Earth B
![Earth B Frames](earthB_frames.png)

## 2. PCA Analysis

Principal Component Analysis was performed on both datasets (10 modes).

**Commands:**
\`\`\`bash
# Run PCA
$PCA 10 earthA.fits modesA.fits coeffsA.fits
$PCA 10 earthB.fits modesB.fits coeffsB.fits
\`\`\`

**Note on Mode 0:** The PCA implementation does NOT re-center (de-average) the input data. Therefore, the first mode (Mode 0) represents the average intensity of the dataset.

### Earth A Modes (First 5)
![Earth A Modes](modesA.png)

### Earth B Modes (First 5)
![Earth B Modes](modesB.png)

## 3. PCA Reconstruction

The datasets were reconstructed using the computed modes and coefficients.

**Commands:**
\`\`\`bash
# Reconstruct
$BUILD_DIR/milk-streamtelemetry-recon modesA.fits coeffsA.fits reconA.fits
$BUILD_DIR/milk-streamtelemetry-recon modesB.fits coeffsB.fits reconB.fits
\`\`\`

### Earth A Reconstruction
![Earth A Reconstruction](reconA_frames.png)

### Earth B Reconstruction
![Earth B Reconstruction](reconB_frames.png)

## 4. CCA Analysis

Canonical Correlation Analysis was performed between Earth A and Earth B, using the top 10 PCA modes for data reduction.

**Commands:**
\`\`\`bash
# Run CCA (5 vectors, using top 10 PCA modes)
$BUILD_DIR/milk-streamtelemetry-cca -npca 10 5 earthA.fits earthB.fits
\`\`\`

### Earth A Canonical Vectors (First 5)
![Earth A CCA](ccaA_vectors.png)

### Earth B Canonical Vectors (First 5)
![Earth B CCA](ccaB_vectors.png)

## 5. Visualization Commands

The PNG images in this report were generated using the \`3DFITS-to-png\` tool:

\`\`\`bash
# Visualize Frames
$FITS2PNG earthA.fits earthA_frames.png -n 5 -geom 5x1
$FITS2PNG earthB.fits earthB_frames.png -n 5 -geom 5x1

# Visualize Modes
$FITS2PNG modesA.fits modesA.png -slices 0,1,2,3,4 -geom 5x1
$FITS2PNG modesB.fits modesB.png -slices 0,1,2,3,4 -geom 5x1

# Visualize Reconstruction
$FITS2PNG reconA.fits reconA_frames.png -n 5 -geom 5x1
$FITS2PNG reconB.fits reconB_frames.png -n 5 -geom 5x1

# Visualize CCA
$FITS2PNG ccaA.fits ccaA_vectors.png -slices 0,1,2,3,4 -geom 5x1
$FITS2PNG ccaB.fits ccaB_vectors.png -slices 0,1,2,3,4 -geom 5x1
\`\`\`

EOF

echo "Test Complete. Results in $TEST_DIR"
